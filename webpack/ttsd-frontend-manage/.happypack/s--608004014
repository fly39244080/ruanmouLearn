'use strict';

require('publicJs/plugins/jQuery.md5');
var commonFun = require('publicJs/commonFun');
var ValidatorObj = require('publicJs/validator');

var weChatRegister = globalFun.$('#weChatRegister');
var formRegister = globalFun.$('#formRegister');

var validator = new ValidatorObj.ValidatorForm();
var $errorBox = $('.error-box', $(formRegister));
var imageCaptcha = globalFun.$('#imageCaptcha');
var captchaSrc = '/register/user/image-captcha';

$('#imageCaptcha').on('click', function () {
    commonFun.refreshCaptcha(this, captchaSrc);
    formRegister.captcha.value = '';
});

//获取验证码
(function () {
    var formCaptcha = globalFun.$('#formCaptcha');
    var $getCaptcha = $(formRegister).find('.get-captcha');

    function sendCaptcha() {
        var ajaxOption = {
            url: '/register/user/send-register-captcha',
            type: 'POST',
            data: $(formCaptcha).serialize()
        };
        commonFun.useAjax(ajaxOption, function (responseData) {
            $getCaptcha.prop('disabled', false);

            var data = responseData.data;
            if (data.status && !data.isRestricted) {
                //获取手机验证码成功，，并开始倒计时
                commonFun.countDownLoan({
                    btnDom: $getCaptcha,
                    isAfterText: '获取验证码',
                    textCounting: 's'
                }, function () {
                    //倒计时结束后刷新验证码
                    commonFun.refreshCaptcha(imageCaptcha, captchaSrc);
                });
            } else if (!data.status && data.isRestricted) {
                commonFun.refreshCaptcha(imageCaptcha, captchaSrc);
                formRegister.captcha.value = '';
                layer.msg('短信发送频繁，请稍后再试');
            } else if (!data.status && !data.isRestricted) {
                commonFun.refreshCaptcha(imageCaptcha, captchaSrc);
                formRegister.captcha.value = '';
                layer.msg('图形验证码不正确');
            }
        });
    }

    $getCaptcha.on('click', function () {
        $getCaptcha.prop('disabled', true);
        var imageCaptcha = formCaptcha.imageCaptcha.value;

        if (/\d{5}/.test(imageCaptcha)) {
            sendCaptcha();
        } else {
            layer.msg('请输入正确的图形验证码');
            $getCaptcha.prop('disabled', false);
        }
    });
})();

//验证码是否正确
validator.newStrategy(formRegister.captcha, 'isCaptchaValid', function (errorMsg, showErrorAfter) {
    var getResult = '',
        that = this,
        _arguments = arguments;

    var _phone = formRegister.mobile.value,
        _captcha = formRegister.captcha.value;

    //先判断手机号格式是否正确
    if (!/(^1[0-9]{10}$)/.test(_phone)) {
        return;
    }
    commonFun.useAjax({
        type: 'GET',
        async: false,
        url: '/register/user/mobile/' + _phone + '/captcha/' + _captcha + '/verify'
    }, function (response) {
        if (response.data.status) {
            // 如果为true说明验证码正确
            getResult = '';
            ValidatorObj.isHaveError.no.apply(that, _arguments);
        } else {
            getResult = errorMsg;
            ValidatorObj.isHaveError.yes.apply(that, _arguments);
        }
    });
    return getResult;
});

validator.add(formRegister.password, [{
    strategy: 'isNonEmpty',
    errorMsg: '密码不能为空'
}, {
    strategy: 'checkPassword',
    errorMsg: '密码为6位至20位，不能全是数字'
}]);

validator.add(formRegister.captcha, [{
    strategy: 'isNonEmpty',
    errorMsg: '验证码不能为空'
}, {
    strategy: 'isNumber:6',
    errorMsg: '验证码为6位数字'
}, {
    strategy: 'isCaptchaValid',
    errorMsg: '验证码不正确'
}]);

var reInputs = $(formRegister).find('input[validate]');
for (var i = 0, len = reInputs.length; i < len; i++) {
    globalFun.addEventHandler(reInputs[i], "keyup", function () {
        var errorMsg = validator.start(this);
        if (errorMsg) {
            $errorBox.text(errorMsg);
        } else {
            $errorBox.text('');
        }
    });
}

//点击立即注册按钮
formRegister.onsubmit = function (event) {
    event.preventDefault();

    for (var _i = 0, _len = reInputs.length; _i < _len; _i++) {
        var errorMsg = validator.start(reInputs[_i]);
        if (errorMsg) {
            $errorBox.text(errorMsg);
            return;
            // break;
        }
    }

    formRegister.submit();
};