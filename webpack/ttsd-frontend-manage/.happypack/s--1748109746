'use strict';

require('webStyle/login.scss');
var ValidatorObj = require('publicJs/validator');
var commonFun = require('publicJs/commonFun');

var loginForm = globalFun.$('#formLogin');
var imageCaptcha = globalFun.$('#imageCaptcha');
var loginSubmit = $(loginForm).find('.login-submit');

commonFun.refreshCaptcha(imageCaptcha, "/login/captcha");
//刷新验证码
$('#imageCaptcha').on('click', function () {
    commonFun.refreshCaptcha(this, "/login/captcha");
    loginForm.captcha.value = '';
});

//表单校验
var errorDom = $(loginForm).find('.error-box');
var validator = new ValidatorObj.ValidatorForm();
validator.add(loginForm.username, [{
    strategy: 'isNonEmpty',
    errorMsg: '用户名不能为空'
}]);
validator.add(loginForm.password, [{
    strategy: 'isNonEmpty',
    errorMsg: '密码不能为空'
}, {
    strategy: 'checkPassword',
    errorMsg: '密码为6位至20位，不能全是数字'
}]);
validator.add(loginForm.captcha, [{
    strategy: 'isNonEmpty',
    errorMsg: '验证码不能为空'
}]);

var loginInputs = $(loginForm).find('input[validate]');
Array.prototype.forEach.call(loginInputs, function (el) {
    globalFun.addEventHandler(el, 'blur', function () {
        var errorMsg = validator.start(this);
        if (errorMsg) {
            errorDom.text(errorMsg).css('visibility', 'visible');
        } else {
            errorDom.text('').css('visibility', 'hidden');
        }
    });
});

//提交表单前验证表单函数
var validateLogin = function validateLogin() {
    var errorMsg = void 0;
    for (var i = 0, len = loginInputs.length; i < len; i++) {
        errorMsg = validator.start(loginInputs[i]);
        if (errorMsg) {
            errorDom.text(errorMsg).css('visibility', 'visible');
            break;
        }
    }
    return errorMsg ? false : true;
    //返回false代表表单验证没有通过
};

//login表单提交函数
var formSubmit = function formSubmit() {
    loginSubmit.addClass('loading').prop('disabled', true);
    commonFun.useAjax({
        url: "/login",
        type: 'POST',
        data: $(loginForm).serialize()
    }, function (data) {
        loginSubmit.removeClass('loading').prop('disabled', false);
        var redirectUrl = $(loginForm).data('redirect-url');
        if (data.status) {
            //用户角色里是否包含USER角色
            var hasUserRole = _.contains(data.roles, 'USER');
            location.href = hasUserRole ? redirectUrl : "/register/account";
        } else {
            var _imageCaptcha = globalFun.$('#imageCaptcha');
            commonFun.refreshCaptcha(_imageCaptcha, "/login/captcha");
            errorDom.text(data.message).css('visibility', 'visible');
        }
    });
};

loginForm.onsubmit = function (event) {
    event.preventDefault();
    //提交之前得先执行validateLogin验证表单是否通过验证
    formSubmit.before(validateLogin)();
};